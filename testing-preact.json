{"metadata":{"title":"Testing Preact in a React-Focused Codebase","date":"May 3, 2020","excerpt":"Learning in public taken to a new extreme when I was asked to write tests for a heavily-downloaded open-sourced repository.","category":"open-source"},"content":"<p>So, today I had to write tests for an open-sourced library that is meant to compare deeply nested objects in the context of React, called <a href=\"https://github.com/FormidableLabs/react-fast-compare\"><code>react-fast-compare</code></a>. Essentially, we introduced support for Preact and needed to mirror existing tests written for React components to extend over Preact-compiled components.</p>\n<p>In order to better understand this feature (and given that I had no prior experience with Preact), I had to learn what Preact actually is and how it differs from React. This wasn't difficult, as the docs themselves have a versioned \"Differences to React\" on their <a href=\"https://preactjs.com/guide/v10/differences-to-react\">documentation website</a>. TL; DR: Preact is not meant to be a one-for-one replacement of React because it's so focused on being small. </p>\n<p>So, now understanding the difference between these frameworks, I had to compare testing libraries. We were using <a href=\"https://reactjs.org/docs/test-renderer.html\"><code>react-test-renderer</code></a> to test a simple React component that was a h1 with a circular reference to its owner, Container, another React component. There's no equal replacement for testing Preact just yet, so I had to look at a few different libraries to get what I was looking for.</p>\n<p>The objective: Test a similarly recursive component within a Container that has been compiled with React.</p>\n<p>Our options:</p>\n<ol>\n<li><a href=\"\"><code>preact-render-to-string</code></a> in combination with <a href=\"\"><code>html-looks-like</code></a></li>\n<li><a href=\"\"><code>preact-jsx-chai</code></a></li>\n<li><a href=\"\"><code>preact-testing-libary</code></a></li>\n</ol>\n<p>Each of the above libraries serves a specific purpose and provides a different output that we can then validate using <code>sinon</code> and <code>assert</code> (the already-preferred testing libraries being used in the same file).</p>\n<p>Let's look at what the existing tests are doing to better understand what we're trying to duplicate:</p>\n<p>Facebook's own <code>react-test-renderer</code>, according to <a href=\"https://reactjs.org/docs/test-renderer.html\">its docs</a>, \"provides an individual React renderer that can be used to test pure JavaScript objects without depending on the DOm or a native mobile environment.\"</p>\n<p>So, to test our React components, we've been using this package to look at the platform view hierarchy (meant to mimick the DOM tree) rendered by React. We'll do the same to test them in Preact, we just need to find a Preact test renderer that suits our needs.</p>\n<p>Given these test components...</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// component</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ChildWithShouldComponentUpdate</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">React</span>.<span class=\"hljs-title\">Component</span> </span>{\n  <span class=\"hljs-function\"><span class=\"hljs-title\">shouldComponentUpdate</span>(<span class=\"hljs-params\">nextProps</span>)</span> {\n    <span class=\"hljs-comment\">// this.props.children is a h1 with a circular reference to its owner, Container</span>\n    <span class=\"hljs-keyword\">return</span> !equal(<span class=\"hljs-built_in\">this</span>.props, nextProps)\n  }\n  <span class=\"hljs-function\"><span class=\"hljs-title\">render</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>\n  }\n}\n\n<span class=\"hljs-comment\">// container component</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Container</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">React</span>.<span class=\"hljs-title\">Component</span> </span>{\n  <span class=\"hljs-function\"><span class=\"hljs-title\">render</span>(<span class=\"hljs-params\"></span>)</span> {\n    <span class=\"hljs-keyword\">return</span> React.createElement(ChildWithShouldComponentUpdate, {\n      <span class=\"hljs-attr\">children</span>: [\n        React.createElement(<span class=\"hljs-string\">'h1'</span>, <span class=\"hljs-built_in\">this</span>.props.title || <span class=\"hljs-string\">''</span>),\n        React.createElement(<span class=\"hljs-string\">'h2'</span>, <span class=\"hljs-built_in\">this</span>.props.subtitle || <span class=\"hljs-string\">''</span>),\n      ],\n    })\n  }\n}\n</code></pre>\n<p>... combined with these three existing assertions:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// test setup</span>\n<span class=\"hljs-keyword\">let</span> sandbox\n<span class=\"hljs-keyword\">let</span> warnStub\n<span class=\"hljs-keyword\">let</span> childRenderSpy\n\nbeforeEach(<span class=\"hljs-function\">() =></span> {\n  sandbox = sinon.createSandbox()\n  warnStub = sandbox.stub(<span class=\"hljs-built_in\">console</span>, <span class=\"hljs-string\">'warn'</span>)\n  childRenderSpy = sandbox.spy(\n    ChildWithShouldComponentUpdate.prototype,\n    <span class=\"hljs-string\">'render'</span>,\n  )\n})\n\nafterEach(<span class=\"hljs-function\">() =></span> {\n  sandbox.restore()\n})\n\n<span class=\"hljs-comment\">// test 1</span>\nit(<span class=\"hljs-string\">'compares without warning or errors'</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> testRenderer = ReactTestRenderer.create(React.createElement(Container))\n  testRenderer.update(React.createElement(Container))\n  assert.strictEqual(warnStub.callCount, <span class=\"hljs-number\">0</span>)\n})\n\n<span class=\"hljs-comment\">// test 2</span>\nit(<span class=\"hljs-string\">'elements of same type and props are equal'</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> testRenderer = ReactTestRenderer.create(React.createElement(Container))\n  testRenderer.update(React.createElement(Container))\n  assert.strictEqual(childRenderSpy.callCount, <span class=\"hljs-number\">1</span>)\n})\n\n<span class=\"hljs-comment\">// test 3</span>\nit(<span class=\"hljs-string\">'elements of same type with different props are not equal'</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> testRenderer = ReactTestRenderer.create(React.createElement(Container))\n  testRenderer.update(React.createElement(Container, { <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">'New'</span> }))\n  assert.strictEqual(childRenderSpy.callCount, <span class=\"hljs-number\">2</span>)\n})\n</code></pre>\n<p>We can rewrite these assertions and the <code>beforeEach</code> case to render these same components with Preact and validating the same <code>h1</code> and <code>h2</code> elements are making it to the so-called DOM. Our validation library, <code>assert</code>, can compare two objects, so let's try to find a renderer that will return an object for us to assert against.</p>\n<hr>\n<p>Check out the PR <a href=\"https://github.com/FormidableLabs/react-fast-compare/pull/67\">on Github</a>.</p>"}